(Система управления базами данных)
СУБД - программное обеспечение, которое позволяет создавать, управлять, манипулировать и обеспечивать безопасность этих данных. Инструмент.
База данных - структурированное хранилище данных: таблицы, записи, индексы и тп.

[[PostgreSQL]] обеспечивает надежное и эффективное управление транзакционной нагрузкой (OLTP), [[Greenplum]] масштабную аналитическую обработку данных (OLAP), позволяя анализировать большие объемы информации для принятия управленческих решений, мониторинга рисков и повышения качества обслуживания клиентов.
## Функции СУБД
**Хранение данных**
Обеспечивает устойчивое и надежное хранение данных с организацией в виде таблиц, записей и полей.

**Манипулирование данными**
Позволяет создавать, читать, обновлять и удалять данные через специальные языки запросов

**Управление транзакциями**
Обеспечивает атомарность, согласованность, изолированность и долговечность данных (ACID), что гарантирует корректность операций при сбоях.

**Обеспечение безопасности**
Контроль доступа к данным, авторизация и аутентификация пользователей, управление правами и ролями, шифрование.

**Управление целостностью данных**
СУБД обеспечивает соблюдение правил и ограничений (например, первичных ключей, внешних ключей, уникальности).

**Поддержка конкурентного доступа**
Одновременная работа множества пользователей и процессов с защитой от конфликтов и потерь данных.

**Резервное копирование и восстановление**
Возможность сохранять данные и восстанавливать их после сбоев.

**Обеспечение производительности**
Использование индексов, планов запросов и кеширования для ускорения работы с данными.

**Управление данными и метаданными**
Хранение информации о структуре базы данных, пользователях, правах, конфигурации.
## Основные объекты в СУБД
1. **База данных (Database)**  
    Главная контейнерная структура, которая хранит набор таблиц и других объектов. В PostgreSQL может содержать несколько баз данных, каждая из которых изолирована.
    
2. **Схема (Schema)**  
    Логическое пространство имен внутри бд. Группирует таблицы, представления, индексы, функции и тп. Контейнер внутри базы данных, группирующий объекты (таблицы, функции, индексы). Позволяет структурировать данные и обеспечивать логическую организацию.
    
3. **Таблица (Table)**  
    Объект хранения данных. Данные хранятся на диске. Основной объект для хранения данных в виде строк и столбцов. Таблицы могут иметь различные типы данных и ограничения.
    
4. **Индекс (Index)**  
    Структура для ускорения поиска данных в таблицах. PostgreSQL поддерживает различные типы индексов: B-tree, Hash, GiST, GIN и другие. Без индексов PSQL вынужден выполнять полное сканирование таблицы, что неэффективно для больших таблиц.
    
5. **Представления (View)**  
    Виртуальная таблица сохраненный запрос *select*. Виртуальные таблицы, основанные на результатах запроса. Позволяют создавать удобные представления данных без дублирования. **Материализованное представление** - сохраняет результат запроса на диск.
    
6. **Функции и процедуры (Functions and Procedures)**  
    **Функции** - обязаны возвращать, выполняются в рамках транзакции(если в ф-и произойдет ошибка то произойдет откат), могут использоваться в select. **Процедуры** - могут ничего не возвращать, могут выполнять транзакциями внутри себя, вызываются отдельно. Код, выполняемый на стороне СУБД, который расширяет возможности обработки данных. Может быть написан на PL/pgSQL, Python или других языках.
    
7. **Триггеры (Triggers)**  
    Автоматически вызываемые действия при событиях вставки, обновления или удаления данных в таблице.
    
8. **Последовательности (Sequences)**  
    Объекты для генерации уникальных числовых значений, часто используемые для создания автоинкрементных ключей.
    
9. **Типы данных (Data Types)**  
    PostgreSQL поддерживает стандартные типы (integer, varchar, date) и расширенные, включая массивы, JSON, XML.

## Нормализация, денормализация
Устранение аномалий данных, минимизирует избыточность, объясняет логическую целостность. Фундаментальные концепции проектирования баз данных, которые определяют, как структурировать данные для достижения оптимального баланса между целостностью, производительностью и удобством обслуживания.

**Нормализация** - это процесс организации данных в реляционной базе с целью устранения избыточности и предотвращения аномалий при вставке, обновлении и удалении данных.

**Используйте нормализацию когда:**
- Требуется высокая целостность данных
- Частые операции записи/обновления
- Ограниченное пространство хранения
- OLTP-системы (Online Transaction Processing)
### Основные нормальные формы
#### Первая нормальная форма
- Каждое поле содержит только одно атомарное значение
- Отсутствуют повторяющиеся группы данных
- Каждая строка уникальна
#### Вторая нормальная форма
- Выполняются требования 1NF
- Каждый неключевой атрибут полностью зависит от первичного ключа
#### Третья нормальная форма
- Выполняются требования 2NF
- Отсутствуют транзитивные зависимости между неключевыми атрибутами

### Денормализация данных

Это обратный процесс, при котором в нормализованную базу данных намеренно вводится избыточность для повышения производительности чтения.

**Используйте денормализацию когда:**
- Критична производительность чтения
- Редкие обновления данных
- Аналитические запросы и отчеты
- OLAP-системы (Online Analytical Processing)
- Кеширование часто запрашиваемых данных
#### Методы
1. Добавление избыточных данных
2. Материализованные представления
3. JSONB для сложных структур
## Оконные функции
**Оконные функции** - это специальные функции SQL, которые позволяют выполнять вычисления над множеством строк (окном), связанных с текущей строкой в результате запроса, при этом не объединяя строки в одну, как это делают агрегатные функции (вычисление для набора в отдельном столбце). Каждая строка сохраняет свою идентичность и к ней добавляется результат вычисления по окну строк.

При использовании агрегирующих функций с группировкой, количество строк, в запросе, сокращается. А при оконной функции строк столько же сколько и в исходной таблице. 
#### Классы оконных функций
- Агрегирующие (Aggreagate)
Применяются агрегирующие функции - sum, avg, count, min, max
- Ранжирующие (Ranking)
Под OVER обязательно идет ORDER BY, по которому происходит сортировка ранжирования. 
row_number - последовательный ранг строк внутри партиции. Не зависит от повторений
rank - ранг каждой строки внутри партиции. Если есть повторения у них одинаковый ранг, пропуская при этом следующий числовой ранг.
dense_rank - то же что и rank но у повторений не одинаковый ранг а последовательный.
- Функции смещения (Value)
При перемещении по партиции таблицы, позволяет обращаться к предыдущему значению строки или крайним значениям строк в партиции.
lag - предыдущее значение столбца по порядку сортировки
lead - следующее значение столбца по порядку сортировки.
FIRST_VALUE()/LAST_VALUE() - функции возвращающие первое или последнее значение столбца в указанной партиции. В качестве аргумента указывает столбец, значение которого нужно вернуть.
### Работа оконной функции
Для каждой строки в результирующем наборе данных определяется окно - набор строк, которые будут участвовать в вычислениях. Окно определяется с помощью конструкции **OVER ()**, внутри которой можно указать:

PARTITION BY - разделение строк на группы (партиции), по которым функция считается независимо. Аналог группы по какому-то столбцу.

ORDER BY - порядок строк внутри партиции, важен для функций, которые зависят от последовательности.

Дополнительные ограничения на окно, например ROWS BETWEEN ... или RANGE BETWEEN ..., которые уточняют, какие именно строки включены в окно относительно текущей.

#### Порядок выполнения

Важно понимать, что оконные функции выполняются после того, как на данные применены WHERE, GROUP BY и HAVING, но до сортировки ORDER BY в итоговом выводе. Это ограничивает возможность использовать оконные функции в WHERE, но дает гибкость для динамического анализа уже обработанных данных.

#### Пример использования оконных функций
Здесь для каждой строки считается сумма продажи за все предыдущие месяцы и текущий, предоставляя динамическое накопление.
```
SELECT month,  
       sales,  
       SUM(sales) OVER (ORDER BY month ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total  
FROM monthly_sales;
```

### Партицирование
Партицирование (секционирование) - это техника разделения одной большой таблицы на несколько меньших физических таблиц, называемых партициями или секциями, при сохранении логической целостности данных.

Партицирование решает несколько важных задач:
- Повышение производительности: запросы обращаются только к нужным партициям
- Упрощение обслуживания: легче архивировать или удалять старые данные
- Параллельная обработка: возможность использования нескольких дисков
- Масштабируемость: управление большими объемами данных становится проще



